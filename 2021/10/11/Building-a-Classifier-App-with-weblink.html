<p><img src="\images\header2.png" alt="" /></p>

<h1 id="building-a-classifier-app-with-weblink">Building a Classifier App with Weblink</h1>

<p><em>Thomas H. Simm, PhD</em></p>

<p>Creating an image classifier app that is on the net! Using Jupyter notebooks, FastAi, Binder and Voila
categories: [fastai, jupyter, Binder, Voila, myBinder, ThomasHSimm]</p>

<p>1) The Model Part</p>

<p>2) The Python Part Of the App</p>

<p>3) The Binder Part</p>

<h2 id="1-the-model-part">1) The model Part</h2>
<p>The model was run on https://colab.research.google.com with a GPU
Necessary to have a GPU for time</p>

<p>Some imports and installs</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">Uqq</span> <span class="n">fastbook</span>
<span class="kn">import</span> <span class="nn">fastbook</span>
<span class="n">fastbook</span><span class="p">.</span><span class="n">setup_book</span><span class="p">()</span>
</code></pre></div></div>

<p>Gets Azure search key to use Bing search API</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'AZURE_SEARCH_KEY'</span><span class="p">,</span> <span class="s">'keygoeshere'</span><span class="p">)</span>
</code></pre></div></div>

<p>Iâ€™m going to do a classifier for holiday types</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">destas</span><span class="o">=</span><span class="p">{</span><span class="s">'beach'</span><span class="p">:{</span><span class="s">'beach'</span><span class="p">,</span><span class="s">'tropical'</span><span class="p">,</span><span class="s">'sea'</span><span class="p">,</span><span class="s">'beach holidays'</span><span class="p">},</span>
        <span class="s">'snow'</span><span class="p">:{</span><span class="s">'ski'</span><span class="p">,</span><span class="s">'snowboard'</span><span class="p">,</span><span class="s">'snow'</span><span class="p">,</span><span class="s">'ski holidays'</span><span class="p">},</span>
        <span class="s">'countryside'</span><span class="p">:{</span><span class="s">'lakes mountains'</span><span class="p">,</span><span class="s">'countryside'</span><span class="p">,</span><span class="s">'forest'</span><span class="p">,</span><span class="s">'fields'</span><span class="p">},</span>
        <span class="s">'city'</span><span class="p">:{</span><span class="s">'city'</span><span class="p">,</span><span class="s">'cities'</span><span class="p">,</span><span class="s">'bars'</span><span class="p">,</span><span class="s">'buildings'</span><span class="p">},</span>
        <span class="s">'safari'</span><span class="p">:{</span><span class="s">'safari'</span><span class="p">,</span><span class="s">'safari holidays'</span><span class="p">,</span><span class="s">'safari park'</span><span class="p">,</span><span class="s">'safari africa'</span><span class="p">}}</span>
</code></pre></div></div>

<p>Creates a folder containing images for each type</p>

<p>Need to add to dir with different searches not delete and add new stuff each time</p>

<p>For eaach holiday type- go through the search topics and add the results together before downloading images to the holiday type folder</p>

<p>This gives 600 pics per holiday type</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'Destinations'</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">path</span><span class="p">.</span><span class="n">mkdir</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># resultsALL
</span><span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">destas</span><span class="p">:</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="n">o</span><span class="p">)</span>
    <span class="n">dest</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">oo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">destas</span><span class="p">[</span><span class="n">o</span><span class="p">]):</span> 
        <span class="c1"># print(oo)
</span>        <span class="n">results</span> <span class="o">=</span> <span class="n">search_images_bing</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">f'</span><span class="si">{</span><span class="n">oo</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ii</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">resultsALL</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">resultsALL</span><span class="p">,</span><span class="n">results</span><span class="p">).</span><span class="n">concat</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resultsALL</span><span class="o">=</span><span class="n">results</span>
    <span class="k">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">shape</span><span class="p">(</span><span class="n">resultsALL</span><span class="p">))</span>
    <span class="n">download_images</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">urls</span><span class="o">=</span><span class="n">resultsALL</span><span class="p">.</span><span class="n">attrgot</span><span class="p">(</span><span class="s">'contentUrl'</span><span class="p">))</span>
</code></pre></div></div>

<p>Create a data block for fastai</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fns</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">dests</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span><span class="p">),</span> 
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span> 
    <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(</span><span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">parent_label</span><span class="p">,</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
</code></pre></div></div>

<p>get rid of failed images</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">failed</span> <span class="o">=</span> <span class="n">verify_images</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
<span class="n">failed</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">unlink</span><span class="p">)</span>
<span class="n">failed</span>
</code></pre></div></div>

<p>Have a look at the images</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dls</span> <span class="o">=</span> <span class="n">dests</span><span class="p">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">dls</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="\images\ic1.png" alt="" /></p>

<p>create a dls for the learner</p>

<ul>
  <li>randomresizedcrop</li>
  <li>default aug transforms</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dests</span> <span class="o">=</span> <span class="n">dests</span><span class="p">.</span><span class="n">new</span><span class="p">(</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="n">RandomResizedCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="n">min_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="n">aug_transforms</span><span class="p">())</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">dests</span><span class="p">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></div>

<p>Do the learning over 4 epochs</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">)</span>
<span class="n">learn</span><span class="p">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="\images\ic2.png" alt="" /></p>

<p>Confusion matrix</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">interp</span> <span class="o">=</span> <span class="n">ClassificationInterpretation</span><span class="p">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
<span class="n">interp</span><span class="p">.</span><span class="n">plot_confusion_matrix</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="\images\ic3.png" alt="ic3" /></p>

<p>Save the model (saves as export.pkl)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>learn.export()
</code></pre></div></div>

<h2 id="2-the-app-in-python">2) The App in python</h2>

<p>Some imports</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Classifier App
# THSimm
</span>
<span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.vision.widgets</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
</code></pre></div></div>

<p>Create parts of the widget</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">learn_inf</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="s">'export.pkl'</span><span class="p">)</span>
<span class="n">btn_upload</span> <span class="o">=</span> <span class="n">widgets</span><span class="p">.</span><span class="n">FileUpload</span><span class="p">()</span>

<span class="n">out_pl</span> <span class="o">=</span> <span class="n">widgets</span><span class="p">.</span><span class="n">Output</span><span class="p">()</span>
<span class="n">out_pl</span><span class="p">.</span><span class="n">clear_output</span><span class="p">()</span>

<span class="n">lbl_pred</span> <span class="o">=</span> <span class="n">widgets</span><span class="p">.</span><span class="n">Label</span><span class="p">()</span>
</code></pre></div></div>

<p>Function occurs on click upload</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">on_click_classify</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">PILImage</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">btn_upload</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">out_pl</span><span class="p">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">out_pl</span><span class="p">:</span> <span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">to_thumb</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">))</span>
    <span class="n">pred</span><span class="p">,</span><span class="n">pred_idx</span><span class="p">,</span><span class="n">probs</span> <span class="o">=</span> <span class="n">learn_inf</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">lbl_pred</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="s">f'Prediction: </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s">; Probability: </span><span class="si">{</span><span class="n">probs</span><span class="p">[</span><span class="n">pred_idx</span><span class="p">]:.</span><span class="mi">04</span><span class="n">f</span><span class="si">}</span><span class="s">'</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">btn_upload</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_click_classify</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
</code></pre></div></div>

<p>What is displayed</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#hide_output
</span><span class="n">text</span> <span class="o">=</span><span class="s">'Select your plane'</span>

<span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">widgets</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">f"&lt;h1&gt;&lt;font color='Black'&gt;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s">&lt;/h1&gt;</span><span class="se">\
</span><span class="s">                                     &lt;ol text-align: center&gt;&lt;font color='Black'&gt;</span><span class="se">\
</span><span class="s">                                    &lt;li&gt;Beach&lt;/li&gt;</span><span class="se">\
</span><span class="s">                                    &lt;li&gt;Snow&lt;/li&gt;</span><span class="se">\
</span><span class="s">                                    &lt;li&gt;Countryside&lt;/li&gt;</span><span class="se">\
</span><span class="s">                                    &lt;li&gt;City&lt;/li&gt;</span><span class="se">\
</span><span class="s">                                    &lt;li&gt;Safari&lt;/li&gt;</span><span class="se">\
</span><span class="s">                                    &lt;/ol&gt;"</span><span class="p">),</span> 
      <span class="n">btn_upload</span><span class="p">,</span>  <span class="n">out_pl</span><span class="p">,</span> <span class="n">lbl_pred</span><span class="p">])</span> <span class="p">)</span>
</code></pre></div></div>

<h2 id="3-the-binder-part">3) The Binder Part</h2>

<h3 id="binder">Binder</h3>
<blockquote>mybinder.org is an online service for building and sharing reproducible and interactive computational environments from online repositories. Under the hood, it is a federation of BinderHub deployments that are maintained by the Binder community. It serves as both a public service and a demonstration of the BinderHub technology, though it is by no means the only BinderHub in existence. If youâ€™re interested in deploying your own BinderHub for your own uses, please see the BinderHub documentation and donâ€™t hesitate to reach out to the Binder community.</blockquote>

<p>https://mybinder.readthedocs.io/en/latest/introduction.html#preparing-a-repository-for-binder</p>

<p>Basically allowing us to put code online</p>

<h3 id="voila">Voila</h3>
<p>The 2nd import part is Voila which allows us to hide the code and just display outputs</p>

<p>https://voila.readthedocs.io/en/stable/using.html</p>

<h4 id="method">Method:</h4>

<ul>
<li>Create repository on github that is public, containing the ipynb file and a requirements.txt file</li>
<li>Then go to binder https://mybinder.org/</li>
<li>Fill in form as shown below</li></ul>

<p>In requirements.txt:</p>

<blockquote>
  <p>voila
fastai
packaging
ipywidgets</p>
</blockquote>

<p><img src="\images\ic4.png" alt="ic4" /></p>

<h2 id="the-result">The result</h2>

<p>https://mybinder.org/v2/gh/ThomasHSimm/LocationsClassifier/HEAD?urlpath=%2Fvoila%2Frender%2FAppForDestClass.ipynb</p>

<p>https://tinyurl.com/LocClassAppThomasHSimm</p>

<hr />

<p><img src="\images\ic5.png" alt="ic5" /></p>

